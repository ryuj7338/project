<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>

<meta charset="UTF-8"/>

<!-- ê³µí†µ CSS/JS -->
<link rel="stylesheet" href="/resource/common.css"/>
<script src="/resource/common.js" defer></script>

<!-- ì œì´ì¿¼ë¦¬ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<!-- í°íŠ¸ì–´ì¸ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>


<!-- í…Œì¼ìœˆë“œ -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css" rel="stylesheet"/>

<body>
<header>
    <div class="flex items-center bg-white w-full max-w-full px-6 relative">
        <a href="/" class="flex items-center space-x-2">
            <span class="font-bold text-xl text-gray-800">Guardium</span>
        </a>

        <!-- ë©”ë‰´ë°” -->
        <nav class="flex-grow">
            <ul class="flex justify-center space-x-8 text-gray-700 font-semibold h-full items-center">
                <li class="group relative">
                    <a href="/usr/post/intorduce" class="hover:text-indigo-600">ê²½í˜¸ ì†Œê°œ</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/intorduce" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ì›ì´ë€</a></li>
                        <li><a href="/usr/qualification/list" class="block px-4 py-2 hover:bg-indigo-50">ìê²©ìš”ê±´ ë° ìê²©ì¦</a>
                        </li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/news/list" class="hover:text-indigo-600">ê²½í˜¸ ì •ë³´</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/news/list" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ ë‰´ìŠ¤</a></li>
                        <li><a href="/usr/law/list" class="block px-4 py-2 hover:bg-indigo-50">ê´€ë ¨ ë²•ë¥ </a></li>
                        <li><a href="#" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ì—…ì²´</a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/job/list" class="hover:text-indigo-600">ì·¨ì—… ì§€ì›</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/gpt/interview" class="block px-4 py-2 hover:bg-indigo-50">ë©´ì ‘ ì½”ì¹­</a></li>
                        <li><a href="#" class="block px-4 py-2 hover:bg-indigo-50">ìê¸°ì†Œê°œì„œ</a></li>
                        <li><a href="/usr/job/list" class="block px-4 py-2 hover:bg-indigo-50">ì±„ìš© ê³µê³ </a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/post/list?boardId=5" class="hover:text-indigo-600">í•™ìŠµìë£Œ</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/list?boardId=5" class="block px-4 py-2 hover:bg-indigo-50">ê¸°ì¶œë¬¸ì œ</a></li>
                        <li><a href="/usr/post/list?boardId=6" class="block px-4 py-2 hover:bg-indigo-50">ìš”ì•½ìë£Œ</a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/post/list?boardId=1" class="hover:text-indigo-600">ì»¤ë®¤ë‹ˆí‹°</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200 opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/list?boardId=1" class="block px-4 py-2 hover:bg-indigo-50">ì§ˆë¬¸ê²Œì‹œíŒ</a></li>
                        <li><a href="/usr/post/list?boardId=2" class="block px-4 py-2 hover:bg-indigo-50">ì •ë³´ê³µìœ </a></li>
                        <li><a href="/usr/post/list?boardId=3" class="block px-4 py-2 hover:bg-indigo-50">í•©ê²©í›„ê¸°</a></li>
                        <li><a href="/usr/post/list?boardId=4" class="block px-4 py-2 hover:bg-indigo-50">ììœ ê²Œì‹œíŒ</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ìš°ì¸¡ ì•„ì´ì½˜ -->
        <div class="flex items-center space-x-6 ml-8 relative" style="overflow: visible">
            <button id="alertBtn"
                    class="text-gray-600 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 relative"
                    type="button">
                <i class="fa-regular fa-bell fa-lg" style="color: #000000;"></i>
                <span id="alertBadge"
                      class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
            </button>
            <a href="/usr/member/myPage" class="text-gray-600 hover:text-gray-900">
                <i class="fa-regular fa-user fa-lg" style="color: #000000;"></i></a>
            <a href="/usr/member/doLogout" class="text-gray-600 hover:text-gray-900"><i
                    class="fa-solid fa-right-from-bracket fa-lg" style="color: #000000;"></i></a>

            <div id="alertDropdown"
                 class="hidden absolute right-0 bg-white rounded-md shadow-lg overflow-auto z-50 border border-gray-300"
                 style="top: 100%; margin-top: 0.75rem; width: 300px; max-height: 600px;">


                <ul id="alertList" class="divide-y divide-gray-200 p-0 m-0 list-none">
                    <!-- AJAXë¡œ ì•Œë¦¼ í•­ëª© ì¶”ê°€ -->

                </ul>

                <div class="text-center py-2 border-t">
                    <a href="#" onclick="openNotificationPopup()"
                       class="text-blue-600 text-sm font-medium hover:underline hover:text-blue-800">
                        ì „ì²´ ì•Œë¦¼ ë³´ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>



<script>
    // ì•Œë¦¼ ë„ì°© ì‹œ ë¹¨ê°„ ì  ë³´ì´ê²Œ í•˜ê¸°
    function showAlertBadge() {
        const badge = document.getElementById("alertBadge");
        if (badge) {
            badge.classList.remove("hidden");
        } else {
            console.warn("âš  alertBadge ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }

    // ë²¨ ì•„ì´ì½˜ í´ë¦­ ì‹œ ë±ƒì§€ ìˆ¨ê¸°ê³  ì„œë²„ì— ì „ì²´ ì½ìŒ ì²˜ë¦¬ ìš”ì²­
    document.getElementById("alertBtn").addEventListener("click", function () {
        document.getElementById("alertBadge").classList.add("hidden");

        fetch('/usr/notifications/markAllAsRead', {
            method: 'POST'
        }).then(res => res.json()).then(data => {
            if (data.resultCode === 'S-1') {
                console.log("ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ë¨");
            }
        });
    });
</script>


<c:if test="${hasUnreadNotification}">
    <script>
        window.addEventListener("DOMContentLoaded", function () {
            showAlertBadge();
        });
    </script>
</c:if>


<script>
    $('#alertBtn').on('click', function (e) {
        e.stopPropagation();

        const $dropdown = $('#alertDropdown');
        if ($dropdown.is(':visible')) {
            $dropdown.hide();
            return;
        }

        $.ajax({
            url: '/usr/notifications/recent',
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                const $list = $('#alertList');
                $list.empty();

                if (data.length === 0) {
                    $list.append('<li class="p-4 text-center text-gray-500">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                } else {
                    data.forEach(function (noti, i) {
                        console.log(`âœ… ${i + 1}ë²ˆì§¸ ì•Œë¦¼ ê°ì²´:`, noti);

                        const $li = $('<li>')
                            .addClass('notification-item p-4 hover:bg-gray-100 cursor-pointer')
                            .attr('data-id', noti.id)
                            .attr('data-link', noti.link)
                            .append(
                                $('<div>').addClass('font-semibold').text(noti.title),
                                $('<div>').addClass('text-xs text-gray-500').text(noti.timeAgo || '')
                            );

                        $('#alertList').append($li);
                    });

                }
                $dropdown.show();
            },
            error: function (xhr) {
                const $list = $('#alertList');
                $list.empty();

                if (xhr.status === 401) {
                    $list.append(`<li class="p-4 text-center text-gray-500">
                        ë¡œê·¸ì¸ í›„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
                        <a href="/usr/member/login" class="text-blue-600 hover:underline text-sm mt-1 inline-block">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
                    </li>`);
                } else {
                    $list.append('<li class="p-4 text-center text-red-500">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>');
                }
                $dropdown.show();
            }
        });
    });

    // âœ… í´ë¦­ëœ ì•Œë¦¼ ì²˜ë¦¬
    $(document).on('click', '.notification-item', function () {
        const $li = $(this);
        const notificationId = $li.data('id');
        const link = $li.data('link');

        console.log("ğŸŸ¢ í´ë¦­ëœ ì•Œë¦¼ ID:", notificationId);
        console.log("ğŸŸ¢ í´ë¦­ëœ ì•Œë¦¼ ë§í¬:", link);

        if (!notificationId || isNaN(notificationId)) {
            console.warn("âš  ì˜ëª»ëœ ì•Œë¦¼ ID:", notificationId);
            return;
        }


    });

    $('#alertList').on('click', '.notification-item', function () {
        const id = $(this).data('id');
        const link = $(this).data('link');

        // ì „ì²´ ì½ìŒ ì²˜ë¦¬ (ì„ íƒ)
        fetch('/usr/notifications/markAllAsRead', {
            method: 'POST'
        }).then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ìƒˆ ì°½ìœ¼ë¡œ ë§í¬ ì—´ê¸°
                    if (link) {
                        window.open(link, '_blank', 'width=800,height=600,scrollbars=yes');
                    }
                }
            });
    });

</script>

<script>
    function openNotificationPopup() {
        const popup = window.open('/usr/notifications/list', 'ì•Œë¦¼í•¨', 'width=500,height=600,resizable=no,scrollbars=yes');
    }

</script>


</body>
</html>
