<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- ê³µí†µ CSS/JS -->
    <link rel="stylesheet" href="/resource/common.css"/>
    <script src="/resource/common.js" defer></script>

    <!-- ì œì´ì¿¼ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- í°íŠ¸ì–´ì¸ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <!-- í…Œì¼ìœˆë“œ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.1.4/tailwind.min.css" rel="stylesheet"/>
</head>
<body>
<header>
    <div class="flex items-center bg-white w-full max-w-full px-6 relative">
        <a href="/" class="flex items-center space-x-2">
            <span class="font-bold text-xl text-gray-800">Guardium</span>
        </a>

        <!-- ë©”ë‰´ë°” -->
        <nav class="flex-grow">
            <ul class="flex justify-center space-x-8 text-gray-700 font-semibold h-full items-center">
                <li class="group relative">
                    <a href="/usr/post/intorduce" class="hover:text-indigo-600">ê²½í˜¸ ì†Œê°œ</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200
                               opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto
                               transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/intorduce" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ì›ì´ë€</a></li>
                        <li><a href="/usr/qualification/list" class="block px-4 py-2 hover:bg-indigo-50">ìê²©ìš”ê±´ ë° ìê²©ì¦</a>
                        </li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/news/list" class="hover:text-indigo-600">ê²½í˜¸ ì •ë³´</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200
                               opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto
                               transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/news/list" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ ë‰´ìŠ¤</a></li>
                        <li><a href="/usr/law/list" class="block px-4 py-2 hover:bg-indigo-50">ê´€ë ¨ ë²•ë¥ </a></li>
                        <li><a href="#" class="block px-4 py-2 hover:bg-indigo-50">ê²½í˜¸ì—…ì²´</a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/job/list" class="hover:text-indigo-600">ì·¨ì—… ì§€ì›</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200
                               opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto
                               transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/gpt/interview" class="block px-4 py-2 hover:bg-indigo-50">ë©´ì ‘ ì½”ì¹­</a></li>
                        <li><a href="#" class="block px-4 py-2 hover:bg-indigo-50">ìê¸°ì†Œê°œì„œ</a></li>
                        <li><a href="/usr/job/list" class="block px-4 py-2 hover:bg-indigo-50">ì±„ìš© ê³µê³ </a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/post/list?boardId=5" class="hover:text-indigo-600">í•™ìŠµìë£Œ</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200
                               opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto
                               transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/list?boardId=5" class="block px-4 py-2 hover:bg-indigo-50">ê¸°ì¶œë¬¸ì œ</a></li>
                        <li><a href="/usr/post/list?boardId=6" class="block px-4 py-2 hover:bg-indigo-50">ìš”ì•½ìë£Œ</a></li>
                    </ul>
                </li>
                <li class="group relative">
                    <a href="/usr/post/list?boardId=1" class="hover:text-indigo-600">ì»¤ë®¤ë‹ˆí‹°</a>
                    <ul class="absolute left-0 top-full mt-1 bg-white shadow-lg rounded-md border border-gray-200
                               opacity-0 group-hover:opacity-100 pointer-events-none group-hover:pointer-events-auto
                               transition-opacity duration-200 min-w-[160px] z-50">
                        <li><a href="/usr/post/list?boardId=1" class="block px-4 py-2 hover:bg-indigo-50">ì§ˆë¬¸ê²Œì‹œíŒ</a></li>
                        <li><a href="/usr/post/list?boardId=2" class="block px-4 py-2 hover:bg-indigo-50">ì •ë³´ê³µìœ </a></li>
                        <li><a href="/usr/post/list?boardId=3" class="block px-4 py-2 hover:bg-indigo-50">í•©ê²©í›„ê¸°</a></li>
                        <li><a href="/usr/post/list?boardId=4" class="block px-4 py-2 hover:bg-indigo-50">ììœ ê²Œì‹œíŒ</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- ìš°ì¸¡ ì•„ì´ì½˜ -->
        <div class="flex items-center space-x-6 ml-8 relative" style="overflow: visible">
            <button id="alertBtn"
                    class="relative text-gray-600 hover:text-gray-900 focus:outline-none"
                    type="button">
                <i class="fa-regular fa-bell fa-lg"></i>
                <span id="alertBadge"
                      class="absolute top-1 right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </button>
            <a href="/usr/member/myPage" class="text-gray-600 hover:text-gray-900">
                <i class="fa-regular fa-user fa-lg"></i>
            </a>
            <a href="/usr/member/doLogout" class="text-gray-600 hover:text-gray-900">
                <i class="fa-solid fa-right-from-bracket fa-lg"></i>
            </a>

            <div id="alertDropdown"
                 class="absolute right-0 bg-white rounded-md shadow-lg overflow-auto z-50 border border-gray-300"
                 style="top:100%; width:300px; max-height:600px; display:none;">
                <ul id="alertList" class="flex flex-col justify-center items-center min-h-[160px] divide-y divide-gray-200 p-0 m-0 list-none">
                    <!-- AJAXë¡œ ì•Œë¦¼ í•­ëª©ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
                <div class="sticky bottom-0 bg-white border-t border-gray-200 text-center py-1">
                    <a href="javascript:void(0)" id="showAllNotifications"
                       class="text-blue-600 text-sm font-medium hover:underline hover:text-blue-800">
                        ì „ì²´ ì•Œë¦¼ ë³´ê¸°
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
    // ë°°ì§€ ë³´ì´ê¸°/ìˆ¨ê¹€ í•¨ìˆ˜
    window.showAlertBadge = () => document.getElementById('alertBadge')?.classList.remove('hidden');
    window.hideAlertBadge = () => document.getElementById('alertBadge')?.classList.add('hidden');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ unreadCount API í˜¸ì¶œ
    document.addEventListener('DOMContentLoaded', function () {
        fetch('${pageContext.request.contextPath}/usr/notifications/unreadCount')
            .then(res => res.json())
            .then(json => {
                const cnt = (json.data?.count ?? json.data1) || 0;
                if (json.resultCode === 'S-1' && cnt > 0) {
                    showAlertBadge();
                } else {
                    hideAlertBadge();
                }
            })
            .catch(() => hideAlertBadge());
    });
</script>

<script>
    const cp = '${pageContext.request.contextPath}';

    $(function () {

        // timeAgo ê³„ì‚° í•¨ìˆ˜ (ìƒëµ)
        function calcTimeAgo(ms) {
            const diff = Date.now() - ms;
            const sec = Math.floor(diff / 1000);
            const min = Math.floor(sec / 60);
            const hr = Math.floor(min / 60);
            const day = Math.floor(hr / 24);
            if (day > 0) return day + 'ì¼ ì „';
            if (hr > 0) return hr + 'ì‹œê°„ ì „';
            if (min > 0) return min + 'ë¶„ ì „';
            if (sec > 5) return sec + 'ì´ˆ ì „';
            return 'ë°©ê¸ˆ ì „';
        }

        function updateTimeAgo() {
            $('.time-ago').each(function () {
                const ms = parseInt($(this).data('time'), 10);
                if (!isNaN(ms)) $(this).text(calcTimeAgo(ms));
            });
        }

        setInterval(updateTimeAgo, 60000);

        // ë²¨ ì•„ì´ì½˜ í´ë¦­ â†’ ì „ì²´ ì½ìŒ ì²˜ë¦¬ + ë“œë¡­ë‹¤ìš´ í† ê¸€ + ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸°
        $('#alertBtn').on('click', function (e) {
            e.stopPropagation();
            $('#alertBadge').addClass('hidden');

            const $dd = $('#alertDropdown');
            if ($dd.is(':visible')) {
                return $dd.hide();
            }
            $dd.show(); // ğŸ’¡ ë²¨ í´ë¦­í•˜ë©´ ë¬´ì¡°ê±´ ë“œë¡­ë‹¤ìš´ show

            // ìµœê·¼ ì•Œë¦¼ ë¶ˆëŸ¬ì˜¤ê¸° (AJAX)
            $.getJSON(cp + '/usr/notifications/recent', function (data) {
                const $list = $('#alertList').empty();
                if (!data.length) {
                    $list.append('<li class="p-2 text-center text-gray-500">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>');
                } else {
                    data.forEach(noti => {
                        const isRead = noti.read === true;

                        let iconHtml = '<i class="fa fa-bell text-gray-400"></i>';
                        if (noti.type === 'LIKE_POST') {
                            iconHtml = '<i class="fa fa-heart text-red-500"></i>';
                        } else if (noti.type === 'LIKE_COMMENT') {
                            iconHtml = '<i class="fa fa-heart text-blue-400"></i>';
                        } else if (noti.type === 'COMMENT') {
                            iconHtml = '<i class="fa fa-comment text-green-500"></i>';
                        } else if (noti.type === 'REPLY') {
                            iconHtml = '<i class="fa fa-reply text-indigo-500"></i>';
                        }

                        const $li = $('<li>')
                            .addClass('notification-item p-2 flex items-start space-x-2')
                            .addClass(isRead ? 'read' : 'unread')
                            .attr({'data-id': noti.id, 'data-link': noti.link});

                        const $icon = $('<span>').addClass('mr-2 mt-1').html(iconHtml);

                        const $content = $('<div>').addClass('flex-1');
                        const $title = $('<div>')
                            .addClass('font-semibold text-sm leading-tight')
                            .text(noti.title);
                        const $time = $('<div>')
                            .addClass('text-xs text-gray-500 time-ago')
                            .attr('data-time', noti.regDateMs)
                            .text(calcTimeAgo(noti.regDateMs));
                        const $delBtn = $('<button>')
                            .addClass('delete-btn text-gray-400 hover:text-red-500 ml-2')
                            .attr('title', 'ì‚­ì œ')
                            .html('&times;');

                        $content.append($title, $time);
                        $li.append($icon, $content, $delBtn);
                        $list.append($li);
                    });

                    updateTimeAgo();
                }
            }).fail(function (xhr) {
                const $list = $('#alertList').empty();
                if (xhr.status === 401) {
                    $list.append(
                        `<li class="flex flex-col items-center justify-center w-full py-4">
                    <div class="text-red-600 text-base mb-2">ë¡œê·¸ì¸ í›„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    <a href="${cp}/usr/member/login" class="inline-block px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-800 transition text-sm font-semibold">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
                </li>`
                    );
                } else {
                    $list.append('<li class="p-2 text-center text-red-500">ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>');
                }
                $dd.show(); // â— failì—ì„œë„ ë°˜ë“œì‹œ show!
            });
        });

    })

    // ê°œë³„ ì•Œë¦¼ í´ë¦­: ì½ìŒ ì²˜ë¦¬ â†’ ìŠ¤íƒ€ì¼ í† ê¸€ â†’ íŒì—… ë„ìš°ê¸° (ë“œë¡­ë‹¤ìš´ì€ ìœ ì§€)
    $(document).on('click', '#alertList .notification-item', function (e) {
        if ($(e.target).hasClass('delete-btn')) return;
        e.stopPropagation();
        e.preventDefault();

        const $it = $(this);
        const id = $it.data('id');
        const link = $it.data('link');

        $.post(cp + '/usr/notifications/markAsRead',
            {notificationId: id},
            function (json) {
                if (json.resultCode === 'S-1') {
                    $it.removeClass('unread').addClass('read');
                }
            }, 'json'
        ).always(function () {
            setTimeout(function () {
                const url = link.startsWith('/') ? link : (cp + '/' + link);
                window.open(url, 'ì•Œë¦¼ìƒì„¸', 'width=700,height=700,scrollbars=yes');
                // ì•Œë¦¼ ë°•ìŠ¤ëŠ” ì—¬ê¸°ì„œ ë‹«ì§€ ì•ŠìŠµë‹ˆë‹¤.
            }, 300);
        });
    });

    // ì‚­ì œ ë²„íŠ¼ í´ë¦­
    $(document).on('click', '.delete-btn', function (e) {
        e.stopPropagation();
        const $item = $(this).closest('.notification-item');
        const id = $item.data('id');
        if (!confirm('ì´ ì•Œë¦¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        $.post(cp + '/usr/notifications/delete',
            {id: id},
            function (json) {
                if (json.resultCode === 'S-1') {
                    $item.remove();

                    if ($('#alertList .notification-item').length === 0) {
                        $('#alertList').append(
                            '<li class="p-2 text-center text-gray-500">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>'
                        );
                    }
                    alert(json.msg || 'ì•Œë¦¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert(json.msg || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }, 'json'
        ).fail(function () {
            alert('ì„œë²„ ì—ëŸ¬ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        });
    });

    // ì „ì²´ ì•Œë¦¼ ë³´ê¸° í´ë¦­: íŒì—… ë„ìš°ê¸°
    $('#showAllNotifications').on('click', function (e) {
        e.preventDefault();
        window.open(
            cp + '/usr/notifications/list',
            'ì•Œë¦¼í•¨',
            'width=500,height=600,resizable=no,scrollbars=yes'
        );
    });

    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸° (ì•Œë¦¼ ì•„ì´í…œ í´ë¦­ ì‹œì—” stopPropagationìœ¼ë¡œ ë°©ì–´ë¨)
    $(document).on('click', function () {
        $('#alertDropdown').hide();

    });


</script>

</body>
</html>
